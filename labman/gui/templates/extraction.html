{% extends sitebase.html %}

{% block head %}
<link rel="stylesheet" href="/static/vendor/css/jquery-ui.min.css" type="text/css"/>
<script src="/static/vendor/js/jquery-ui.min.js" type="text/javascript"></script>

<script src="/static/js/reagentModal.js"></script>

<script type='text/javascript'>

  function disableAll() {
    $('input').prop('disabled', true);
    $('select').prop('disabled', true);
    $('button').prop('disabled', true);
  }

  function extractPlates() {
    // Get the plate ids
    var platesInfo = []
    var plateId;
    for (var item of $('#plate-list').children()) {
      plateId = item.getAttribute('pm-data-plate-id');
      platesInfo.push([plateId, $('#kingfisher-' + plateId).val(), $('#epmotion-' + plateId).val(),
                       $('#epmotion-tool-' + plateId).val(), $('#kit-input-' + plateId).val(),
                       $('#plate-name-' + plateId).val()]);
    }

    // Get the elution volume
    var volume = $('#volume-input').val()
    var extractionDate = $('#extraction-date').val();

    $.post('/process/gdna_extraction', {'extraction_date': extractionDate, 'volume': volume, 'plates_info': JSON.stringify(platesInfo)}, function(data) {
      bootstrapAlert('Information saved', 'success');
      disableAll();
    })
      .fail(function (jqXHR, textStatus, errorThrown) {
        bootstrapAlert(jqXHR.responseText, 'danger');
      });
  };

  function extractionChecks() {
    var plates = $('#plate-list').children();
    if (plates.length === 0) {
      $('#extract-btn').prop('disabled', true);
    } else {
      var disabled = $('#volume-input').val() === '0' || $('#extraction-date').val() === '';
      $.each(plates, function(idx, elem) {
        var plateId = $(elem).attr('pm-data-plate-id');
        disabled = (disabled || $('#div-plate-name-' + plateId).hasClass('has-error') ||
                    $('#kingfisher-' + plateId).val() === null ||
                    $('#epmotion-' + plateId).val() === null ||
                    $('#epmotion-tool-' + plateId).val() === null ||
                    $('#kit-input-' + plateId).val() === '');
      });

      $('#extract-btn').prop('disabled', disabled);
    }
  };

  function removePlate(plateId) {
    // Remove the plate from the list
    $('#plate-' + plateId).remove();
    // Re-enable the button to add the plate to the list
    $('#addBtnPlate' + plateId).prop('disabled', false);
    // Enable/disable the extraction button
    extractionChecks();
  };

  function addPlate(plateId) {
    $.get('/plate/' + plateId + '/', function (data) {
      var $divElem = $("<div>");
      $divElem.addClass('list-group-item');
      $divElem.attr('id', 'plate-' + plateId);
      $divElem.attr('pm-data-plate-id', plateId);
      $divElem.append('<label><h4>' + data.plate_name + '</h4></label>');
      $divElem.append(' (' + data.plate_configuration[1] + ')');
      var $buttonElem = $("<button class='btn btn-danger btn-circle pull-right' onclick='removePlate(" + plateId + ");'>");
      $buttonElem.append("<span class='glyphicon glyphicon-remove'></span>")
      $divElem.append($buttonElem);
      var $formDiv = $("<div>").addClass('form-horizontal').appendTo($divElem);
      // Add the extracted gdna plate name
      var $rowDiv = $('<div>').addClass('form-group').appendTo($formDiv);
      $('<label>').attr('for', 'plate-name-' + plateId).addClass('col-sm-2 control-label').append('gDNA plate name').appendTo($rowDiv);
      var $colDiv = $('<div>').attr('id', 'div-plate-name-' + plateId).addClass('col-sm-10 has-feedback').appendTo($rowDiv);
      $('<span>').addClass('glyphicon glyphicon-remove form-control-feedback').appendTo($colDiv);
      var $inElem = $('<input>').attr('type', 'text').addClass('form-control').attr('id', 'plate-name-' + plateId).val(data.plate_name + ' (gDNA)').appendTo($colDiv);
      $inElem.keyup(function(e) {
        onKeyUpPlateName(e, 'plate-name-' + plateId, extractionChecks);
      });
      $inElem.ready(function() {
        var e = $.Event('keyup');
        $('#plate-name-' + plateId).trigger(e);
      });

      // Add the KingFisher select
      $rowDiv = $('<div>').addClass('form-group').appendTo($formDiv);
      $('<label>').attr('for', 'kingfisher-' + plateId).addClass('col-sm-2 control-label').append('KingFisher robot').appendTo($rowDiv);
      $colDiv = $('<div>').addClass('col-sm-10').appendTo($rowDiv);
      var $selElem = $('<select>').addClass('form-control').attr('id', 'kingfisher-' + plateId).appendTo($colDiv).on('change', extractionChecks);
      $('<option>').prop('selected', true).prop('disabled', true).append('Choose KingFisher robot...').appendTo($selElem);
      {% for robot in kf_robots %}
        $('<option>').attr('value', {{robot['equipment_id']}}).append('{{robot['external_id']}}').appendTo($selElem)
      {% end %}

      // Add the EpMotion select
      $rowDiv = $('<div>').addClass('form-group').appendTo($formDiv);
      $('<label>').attr('for', 'epmotion-' + plateId).addClass('col-sm-2 control-label').append('EpMotion robot').appendTo($rowDiv);
      $colDiv = $('<div>').addClass('col-sm-10').appendTo($rowDiv);
      $selElem = $('<select>').addClass('form-control').attr('id', 'epmotion-' + plateId).appendTo($colDiv).on('change', extractionChecks);
      $('<option>').prop('selected', true).prop('disabled', true).append('Choose EpMotion robot...').appendTo($selElem);
      {% for robot in ep_robots %}
        $('<option>').attr('value', {{robot['equipment_id']}}).append('{{robot['external_id']}}').appendTo($selElem)
      {% end %}

      // Add the EpMotion tool select
      $rowDiv = $('<div>').addClass('form-group').appendTo($formDiv);
      $('<label>').attr('for', 'epmotion-tool-' + plateId).addClass('col-sm-2 control-label').append('EpMotion tool').appendTo($rowDiv);
      $colDiv = $('<div>').addClass('col-sm-10').appendTo($rowDiv);
      $selElem = $('<select>').addClass('form-control').attr('id', 'epmotion-tool-' + plateId).appendTo($colDiv).on('change', extractionChecks);
      $('<option>').prop('selected', true).prop('disabled', true).append('Choose EpMotion tool...').appendTo($selElem);
      {% for tool in tools %}
        $('<option>').attr('value', {{tool['equipment_id']}}).append('{{tool['external_id']}}').appendTo($selElem)
      {% end %}

      // Add the extraction kit input
      $rowDiv = $('<div>').addClass('form-group').appendTo($formDiv);
      $('<label>').attr('for', 'kit-input-' + plateId).addClass('col-sm-2 control-label').append('Extraction kit').appendTo($rowDiv);
      $colDiv = $('<div>').addClass('col-sm-10').appendTo($rowDiv);
      $inElem = $('<input>').attr('type', 'text').addClass('form-control').attr('id', 'kit-input-' + plateId).appendTo($colDiv);
      // Add the Vue element to the extraction kit once it has been loaded into the DOM.
      // This is needed otherwise Vue will not find the input element
      $inElem.ready( function() {
        var vueContainer = $('<div>').attr('id', 'vue-elem-' + plateId).appendTo('#vue-elem');
        var vueComponentCtr = Vue.extend(ReagentModalComponent);
        var vueElem = new vueComponentCtr({propsData: {'idPrefix': 'ek-' + plateId, 'reagentType': 'extraction kit',
                                                       'inputTarget': 'kit-input-' + plateId, 'checksCallback': extractionChecks}});
        vueElem.$mount('#vue-elem-' + plateId);
      });

      // Add the element to the plate list
      $('#plate-list').append($divElem);

      // Disable the button to add the plate to the list
      $('#addBtnPlate' + plateId).prop('disabled', true);

      // Hide the modal to add plates
      $('#addPlateModal').modal('hide');

      // Enable/disable the extraction button
      extractionChecks();
    })
      .fail(function (jqXHR, textStatus, errorThrown) {
        bootstrapAlert(jqXHR.responseText, 'danger');
        $('#addPlateModal').modal('hide');
      });
  };

  $(document).ready(function(){
    var plateIds = {% raw plate_ids %};

    // Set the plate search table
    var table = $('#searchPlateTable').DataTable(
      {'ajax': {'url': '/plate_list', 'data': {'plate_type': 'sample'}},
       'columnDefs': [{'targets': -1,
                       'data': null,
                       'render': function(data, type, row, meta){
                         var plateId = data[0];
                         return "<button id='addBtnPlate" + plateId + "' class='btn btn-success btn-circle-small'><span class='glyphicon glyphicon-plus'></span></button>";
                       }
                      }]
      }
    );
    // Add the function to the buttons that add the plate to the extraction process
    $('#searchPlateTable tbody').on('click', 'button', function() {
      addPlate(table.row( $(this).parents('tr') ).data()[0]);
    });

    // Add the initial plates to the list
    for (var pId of plateIds) {
      addPlate(pId);
    }
    $('#volume-input').on('change', extractionChecks);
    $('#extraction-date').datepicker();
    $('#extraction-date').datepicker('setDate', new Date());
    $('#extraction-date').on('change', extractionChecks);
  });
</script>
{% end %}

{% block content %}

<label><h3>gDNA plate extraction</h3></label>

<!-- Plates div -->
<div>
  <label><h4>Plates being extracted</h4></label>
  <button class='btn btn-success' data-toggle='modal' data-target='#addPlateModal'><span class='glyphicon glyphicon-plus'></span> Add plate</button>
  <div id='plate-list'>
  </div>
</div>

<!-- Elution volume -->
<div class='form-group'>
  <label class='control-label'><h4>Elution volume (&micro;l):</h4></label>
  <input type='number' id='volume-input' class='form-control' min="0" value="100"/>
</div>

<!-- Extraction date
This defaults to today, but the wet lab requested to be able to change it just
in case that there are times that they populate the information after the fact.
-->
<div class='form-group'>
  <label class='control-label'><h4>Extraction date:</h4></label>
  <input type='text' id='extraction-date' class='form-control'/>
</div>

<div>
  <button id='extract-btn' onclick="extractPlates();" class='btn btn-success' disabled><span class='glyphicon glyphicon-share'></span> Extract</button>
</div>

<!-- Modal to add a plate -->
<div class='modal fade' tabindex='-1' role='dialog' id='addPlateModal'>
  <div class='modal-dialog modal-lg'>
    <div class='modal-content'>
      <div class='modal-header'>
        <button type='button' class='close' data-dismiss='modal' aria-hidden='true'>&times;</button>
        <h3>Add plate to extract</h3>
      </div>
      <div class='modal-body'>
        <table id="searchPlateTable" class="display" cellspacing="0" width="100%">
          <thead>
            <tr>
              <th>Plate id</th>
              <th>Plate name</th>
              <th>Add</th>
            </tr>
          </thead>
        </table>
      </div>
    </div>
  </div>
</div>

<div id='vue-elem'></div>


{% end %}
